{% comment %}
This template include expects the following variables:
questionTypes - the QuestionTypes structure from Instructors/questionTypes.py
q - a question dictionary structure as generated by the appropriate function in questionTypes
i - the index of the q. If there is only a single question on the page, any index may be used
graded - a boolean which should be true when the challenge has been graded and you are displaying results
showcorrect - a boolean reflects whether or not the correct answer should be displayed
instructorview - a boolean which reflects whether or not we're in the instructor view (show points for problem)
{% endcomment %}
<link rel="stylesheet" href="/static/ThirdParty/ckeditor/content-styles.css">
{% if i != 1 %}
<div class="divider"></div>
{% endif %}
{% if q.type != questionTypes.dynamic and q.type != questionTypes.templatedynamic %}
{% if q.type == questionTypes.multipleChoice %}
<div id="scrollspy-{{i}}" class="row scrollspy">
  <h4>Problem {{i}} (Multiple Choice)</h4>
  <div class="ck-content" style="margin-left: 10px"> {{q.questionText|safe}} </div>
</div>
{% elif q.type == questionTypes.multipleAnswers %}
<div id="scrollspy-{{i}}" class="row scrollspy">
  <h4>Problem {{i}} (Multiple Answer)</h4>
  <div class="ck-content" style="margin-left: 10px"> {{q.questionText|safe}} </div>
</div>
{% elif q.type == questionTypes.matching %}
<div id="scrollspy-{{i}}" class="row scrollspy">
  <h4>Problem {{i}} (Matching)</h4>
  <div class="ck-content" style="margin-left: 10px"> {{q.questionText|safe}} </div>
</div>
{% elif q.type == questionTypes.trueFalse %}
<div id="scrollspy-{{i}}" class="row scrollspy">
  <h4>Problem {{i}} (True/False)</h4>
  <div class="ck-content" style="margin-left: 10px"> {{q.questionText|safe}} </div>
</div>
{% elif q.type == questionTypes.parsons %}
<div id="scrollspy-{{i}}" class="row scrollspy">
  <h4>Problem {{i}} (Parsons)</h4>
  <div class="ck-content" style="margin-left: 10px"> {{q.questionText|safe}} </div>
</div>
{% endif %}

{% elif not graded or not q.hasMultipleParts %}
<div class="row">
  <h4>Question {{i}}</h4>
  {% if q.hasMultipleParts %}
  <div class="row">
    <h5>Part <b>1</b> of <b>{{q.numParts}}</b></h5>
  </div>
  {% endif %}
  <div class="ck-content">
    <div id="{{q.uniqid}}-1-exact">
      <div class="darkClassParent">
        <div id="{{q.uniqid}}-1-darkLayer" class="darkClass" style="display:none"></div>
        {% if graded %}
        <div class="card">
          <div class="card-content">
            {% endif %}
            {{q.questionText|safe}}
            {% if graded %}
          </div>
        </div>
        {% endif %}

        {% if not graded %}
        {% if q.hasMultipleParts or q.submissionsAllowed > 1 %}
        <script>dynamicProblemPartExists.push("{{q.uniqid}}-1");</script>
        <button class="btn waves-effect waves-light" type="button" value="Submit" name="{{q.uniqid}}-1"
          id="{{q.uniqid}}-1-submit" onclick="senddynamicquestion(this.name)">Submit Problem Part<i
            class="material-icons right">send</i></button></form>
        {% endif %}
        {% else %}
        <script>disableInputsInside(document.getElementById("{{q.uniqid}}-1-exact"));</script>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<div id="{{q.uniqid}}-1-results">
</div>
{% endif %}
{% if instructorview %}
<p><b>Total points: {{question.point|safe}}</b></p>
<br />
{% endif %}
{% if graded and q.type != questionTypes.dynamic and q.type != questionTypes.templatedynamic%}
<div class="row">
  <div class="col s12">
    <h5>Your Answer:</h5>
  </div>
</div>
{% endif %}

{% if q.type == questionTypes.multipleChoice %}
<div class="row">
  <div class="col s12">
    {% for j,answer in q.answers_with_count %}
    <div class="row">
      <input name="{{i}}-ans" type="radio" id="{{i}}ans-{{j}}" value="{{j}}" {% if graded %}
        {% if q.user_answer.answerNumber == j %}checked{% else %} disabled {% endif %} {% endif %} />
      <label for="{{i}}ans-{{j}}" style="width: -webkit-fill-available;">
        <div class="ck-content">{% autoescape off %}{{answer.answerText|safe}} {% endautoescape %}</div>
      </label>
    </div>
    {% endfor %}
    {% if hintsUsed and q.questionHasHintsEnabled %}
    <input type="hidden" name="{{i}}hintID" id="{{q.challenge_question_id}}" value="">
    <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 0)" type="button" id="{{q.challenge_question_id}}-basicButton">Get Basic Hint</button>
    <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 1)" type="button" id="{{q.challenge_question_id}}-strongButton">Get Strong Hint</button>
    {% endif %}
  </div>
</div>
{% if graded or instructorview %}
<div class="row">
  <div class="col s12">
    {% if showcorrect or instructorview %}
    <h5>Correct Answer: </h5>
    <blockquote style="width: -webkit-fill-available;">
      <div class="ck-content">{{q.correct_answer_text|safe}} </div>
    </blockquote>
    {% endif %}
    {% if graded %}
    <p>You Scored: <b>{{q.user_points|floatformat:"-2"}}</b> Point(s) out of
      <b>{{q.total_points|floatformat:"-2"}}</b> Point(s)</p>
    {% endif %}
  </div>
  <div class="col s12">
    {% if q.feedback %}
    <p><b>Feedback: </b> {{q.feedback}}</p>
    {% endif %}
  </div>
</div>
{% endif %}

{% elif q.type == questionTypes.multipleAnswers %}
<div class="row">
  <div class="col s12">
    {% for j,answer in q.answers_with_count %}
    <div class="row">
      <input class="filled-in" name="{{i}}-ans" type="checkbox" id="{{i}}ans-{{j}}" value="{{j}}" {% if graded %}
        {% for user_answer in q.user_answers %}{% if j == user_answer.answerNumber %}checked{% endif %}{% endfor %}
        disabled {% endif %} />
      <label for="{{i}}ans-{{j}}" style="width: -webkit-fill-available;">
        <div class="ck-content">{% autoescape off %}{{answer.answerText|safe}} {% endautoescape %}</div>
      </label>
    </div>
    {% endfor %}
  </div>
  {% if hintsUsed and q.questionHasHintsEnabled %}
  <input type="hidden" name="{{i}}hintID" id="{{q.challenge_question_id}}" value="">
  <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 0)" type="button" id="{{q.challenge_question_id}}-basicButton">Get Basic Hint</button>
  <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 1)" type="button" id="{{q.challenge_question_id}}-strongButton">Get Strong Hint</button>
  {% endif %}
</div>
{% if graded or instructorview %}
<div class="row">
  <div class="col s12">
    {% if showcorrect or instructorview %}
    <h5>Correct Answer(s): </h5>
    <blockquote style="width: -webkit-fill-available;">
      <div class="ck-content">
        {% for correct_answer_text in q.correct_answer_texts %}
        {{correct_answer_text|safe}} <br />
        {% endfor %}
      </div>
    </blockquote>
    {% endif %}
    {% if graded %}
    <p>You Scored: <b>{{q.user_points}}</b> Point(s) out of <b>{{q.total_points}}</b> Point(s)</p>
    {% endif %}
  </div>
  <div class="col s12">
    {% if q.feedback %}
    <p><b>Feedback: </b> {{q.feedback}}</p>
    {% endif %}
  </div>
</div>
{% endif %}

{% elif q.type == questionTypes.matching %}
<style>
  .cards-container {
    -webkit-column-break-inside: avoid;
    /* Chrome, Safari, Opera */
    page-break-inside: avoid;
    /* Firefox */
    break-inside: avoid;
  }
  .cards-container:after {
  content: ' ';
  display: block;
  height: 100px; /* 5px + 5px = 10px */
}
  .card .select-wrapper,
  .card .select-wrapper .caret {
    color: white;
  }

  .card .select-wrapper input.select-dropdown {
    border-bottom-color: white
  }

  @media only screen and (max-width : 600px) {
    .cards-container {
      -webkit-column-count: 1;
      -moz-column-count: 1;
      column-count: 1;
    }
  }

  @media only screen and (min-width : 601px) {
    .cards-container {
      -webkit-column-count: 2;
      -moz-column-count: 2;
      column-count: 2;
    }
  }
</style>
<div class="row">
  <div class="col s12">
    {% for j,answer in q.answers_with_count %}
    <h6><b>Question {{j}}:</b></h6>
    <p>{{answer.answerText}}</p>
    <br />
    {% endfor %}
  </div>
</div>
{% if graded %}
<div class="row">

  <div style="display: flex; flex-wrap: wrap;">
  
    {% for match in q.matches %}
    <div class="col s12 m6" style="display: flex; margin: 0">
    <div class="card primary-color-dark colored-card" style="display: inline-block; overflow: visible; width: 100%;">
      <div class="card-content">
        <span class="card-title">Choice {{match.current_pos}}</span>
        <p>{{match.matchingAnswerText}}</p>
      </div>
      <div class="card-action">
        <span class="card-title">Your Answer</span>
        {% for user_answer in q.user_answers %}
        {% if forloop.counter ==  forloop.parentloop.counter %}
        <p>{{user_answer.answerText}}</p>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    </div>
    {% endfor %}
  </div>

</div>
{% else %}
<div class="row">

  <div style="display: flex; flex-wrap: wrap;">
    {% for match in q.matches %}
    <div class="col s12 m6" style="display: flex; margin: 0">
    <div class="card primary-color-dark colored-card" style="display: inline-block; overflow: visible; width: 100%;">
      <div class="card-content">
        <span class="card-title">Choice {{match.current_pos}}</span>
        <p>{{match.matchingAnswerText}}</p>
      </div>
      <div class="card-action">
        <select name="{{i}}-{{match.current_pos}}">
          {% for k in match.answers_count %}
          <option value="{{k}}">Question {{k}}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    </div>
    {% endfor %}
  </div>

</div>
{% endif %}
{% if graded or instructorview %}

<div class="row">
  <div class="col s12">
    {% if showcorrect or instructorview %}
    <h5>Correct Answer(s): </h5>
    <blockquote>
      <div class="row">

        <div style="display: flex; flex-wrap: wrap;">
          {% for match in q.matches %}
          <div class="col s12 m6" style="display: flex; margin: 0">
          <div class="card primary-color-dark colored-card" style="display: inline-block; overflow: visible; width: 100%;">
            <div class="card-content">
              <span class="card-title">Choice {{match.current_pos}}</span>
              <p>{{match.matchingAnswerText}}</p>
            </div>
            <div class="card-action">
              <span class="card-title">Correct Answer</span>
              <p>{{match.answerText}}</p>
            </div>
          </div>
          </div>
          {% endfor %}
        </div>

      </div>
    </blockquote>
    {% endif %}
    {% if graded %}
    <p>You Scored: <b>{{q.user_points}}</b> Point(s) out of <b>{{q.total_points}}</b> Point(s)</p>
    {% endif %}
  </div>
  <div class="col s12">
    {% if q.feedback %} <p><b>Feedback: </b> {{q.feedback}}</p>
      {% endif %}
  </div>
</div>
{% endif %}

{% elif q.type == questionTypes.trueFalse  %}
<div class="row">
  <div class="col s12">
    <p>
      <input name="{{i}}-ans" type="radio" id="{{i}}ans1" value="t" class="validate" {% if graded %}
        {% if q.user_answer.answerValue == True %}checked{% else %}disabled="disabled" {% endif %} {% endif %} />
      <label for="{{i}}ans1">True</label>
    </p>
    <p>
      <input name="{{i}}-ans" type="radio" id="{{i}}ans2" value="f" class="validate" {% if graded %}
        {% if q.user_answer.answerValue == False %}checked{% else %}disabled="disabled" {% endif %} {% endif %} />
      <label for="{{i}}ans2">False</label>
    </p>
    {% if hintsUsed and q.questionHasHintsEnabled %}
    <input type="hidden" name="{{i}}hintID" id="{{q.challenge_question_id}}" value="">
    <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 0)" type="button" id="{{q.challenge_question_id}}-basicButton">Get Basic Hint</button>
    <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 1)" type="button" id="{{q.challenge_question_id}}-strongButton">Get Strong Hint</button>
    {% endif %}
  </div>
</div>
{% if graded or instructorview %}
<div class="row">
  <div class="col s12">
    {% if showcorrect or instructorview %}
    <h5>Correct Answer: </h5>
    <blockquote>
      {{q.correctAnswerText}}
    </blockquote>
    {% endif %}
    {% if graded %}
    <p>You Scored: <b>{{q.user_points}}</b> Point(s) out of <b>{{q.total_points}}</b> Point(s)</p>
    {% endif %}
  </div>
  <div class="col s12">
    {% if q.feedback %}
    <p><b>Feedback: </b> {{q.feedback}}</p>
    {% endif %}
  </div>
</div>
{% endif %}

{% elif q.type == questionTypes.essay %}
<div class="row">
  <div class="col s12">
    <div class="django-ckeditor-widget" data-field-id="{{i}}-ans">
      <textarea style="border:solid 1px rgba(128, 128, 128, 0.5)" name="{{i}}-ans" rows="2" cols="70" data-processed="0"
        data-config="{{ ckeditor.config }}" data-external-plugin-resources="{{ ckeditor.external_plugin_resources }}"
        data-id="{{i}}-ans" data-type="ckeditortype"></textarea>
    </div>
  </div>
</div>
{# If this is called with Graded, something has gone wrong #}

{% elif q.type == questionTypes.parsons %}
{% if instructorview %}
<div class="row">
  <div class="col s12">
    <div id="model_editor{{i}}" style="height: 20em;" class="editor"><textarea
        style="resize:none; border: solid 1px rgba(128, 128, 128, 0.5)" rows="50"
        cols="70">{{q.model_solution}}</textarea></div>
    <script>
      var editor = ace.edit("model_editor{{i}}");
      editor.setTheme("ace/theme/chrome");
      editor.session.setMode("ace/mode/java");
      editor.setReadOnly(true);
    </script>
  </div>
</div>

{% elif graded %}
<div class="row">
  <div class="col s12">
    <div id="student_editor{{i}}" class="editor"><textarea
        style="resize:none; border: solid 1px rgba(128, 128, 128, 0.5)" rows="20"
        cols="70">{{q.student_solution|safe}}</textarea></div>
    <script>
      var editor = ace.edit("student_editor{{i}}");
      editor.setTheme("ace/theme/chrome");
      editor.session.setMode("ace/mode/java");
      editor.setReadOnly(true);
      editor.setOptions({
        maxLines: Infinity
      });
    </script>
  </div>
  {% if showcorrect %}
  <div class="row">
    <div class="col s12">
      <h5>Example Correct Solution:</h5>
    </div>
  </div>
  <div class="row">
    <div class="col s12">
      <div id="model_editor{{i}}" class="editor"><textarea
          style="resize:none; border: solid 1px rgba(128, 128, 128, 0.5)" rows="20" cols="70"
          name="setupCode{{q.questionID}}">{{q.model_solution}}</textarea></div>
      <script>
        var editor = ace.edit("model_editor{{i}}");
        editor.setTheme("ace/theme/chrome");
        editor.session.setMode("ace/mode/java");
        editor.setReadOnly(true);
        editor.setOptions({
          maxLines: Infinity
        });
      </script>
    </div>
  </div>
  {% endif %}
  <div class="row">
    <div class="row">
      <div class="col s12">
        <p>You Scored: <b>{{q.user_points}}</b> Point(s) out of <b>{{q.total_points}}</b> Point(s)</p>
      </div>
      <div class="col s12">
        {% if q.feedback %}
        <p><b>Feedback: </b> {{q.feedback}}</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% else %}
  <input type="hidden" name="{{i}}studentSol" id="{{i}}_studentSol" value="">
  <input type="hidden" name="{{i}}studentTrash" id="{{i}}_studentTrash" value="">
  <input type="hidden" name="{{i}}feedBackButtonClickCount" id="{{i}}_feedBackButtonClickCount" value="">
  <input type="hidden" id="serious_parson-{{i}}" name="serious_parson-{{i}}" data-id="{{i}}" value="{{i}}">
  <div class="row">
	<div class="col s6 example-container">
		<h6><b>Code Fragments:</b></h6>
		<div class="example-list-{{i}} cdk-drop-list" id="parsonTrash_{{i}}">
			{% for model_solution_data in q.model_solution %}
			<div class="parson-box cdk-drag" data-id="{{model_solution_data.hashVal}}"><pre class="code">{{model_solution_data.line}}</pre></div>
			{% endfor %}
    </div>
    {% if hintsUsed and q.questionHasHintsEnabled %}
    <input type="hidden" name="{{i}}hintID" id="{{q.challenge_question_id}}" value="">
    <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 0)" type="button" id="{{q.challenge_question_id}}-basicButton">Get Basic Hint</button>
    <button class="btn waves-effect waves-light"  onclick="hintClickedByStudent({{q.challenge_question_id}}, 1)" type="button" id="{{q.challenge_question_id}}-strongButton">Get Strong Hint</button>
    {% endif %}
	</div>
		
	<div class="col s6 example-container">
		<h6><b>Solution Area:</b></h6>
		<div class="example-list-{{i}} cdk-drop-list" id="parsonSolution_{{i}}">
		</div>
	</div>
  </div>
  <style>
	.example-container {
		width: 400px;
		max-width: 100%;
	}

	.example-list-{{i}} {
		border: solid 1px #ccc;
		min-height: 60px;
		background: white;
		border-radius: 4px;
		overflow-x: scroll;
		display: flex;
		flex-direction: column;
	}
	.example-placeholder {
    
		display: block;
		width: 1px;
		height: 20px;
		border-left: 2px solid #3f51b5;
		position: relative;
		top: 0px;
		left: 0px;
	}
	.code {
		padding: 10px 10px;
		margin: 0;
	}
	.parson-box {
		
		border-bottom: solid 1px #ccc;
		color: rgba(0, 0, 0, 0.87);
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		box-sizing: border-box;
		cursor: move;
		background: white;
		font-size: 14px;
		word-break: break-all;
		width: fit-content;
		min-width: 100%;
	}
	
	.cdk-drag-preview {
		box-sizing: border-box;
		border-radius: 4px;
		width: fit-content;
		max-width: fit-content;
		min-width: 400px;
		box-shadow: 0 5px 5px -3px rgba(0, 0, 0, 0.2),
					0 8px 10px 1px rgba(0, 0, 0, 0.14),
					0 3px 14px 2px rgba(0, 0, 0, 0.12);
	}

	.cdk-drag-placeholder {
		opacity: 0;
	}

	.cdk-drag-animating {
		transition: transform 250ms cubic-bezier(0, 0, 0.2, 1);
	}

	.parson-box:last-child {
		border: none;
	}

	.example-list-{{i}}.cdk-drop-list-dragging .parson-box:not(.cdk-drag-placeholder) {
		transition: transform 250ms cubic-bezier(0, 0, 0.2, 1);
	}

  </style>
  <script>
	
	// Prettify code lines
	jQuery.fn.prettify = function () { 
		for(var i = 0; i < this.length; i++){
			$(this[i]).html(prettyPrintOne($(this[i]).html())); 
		}
	};
	$('.code').prettify();

	var current_container = undefined;
	var skip = false;
	// Change these variables to update indent amount and max amount of indents
	var indent_amount_in_pixels = 30;
	var max_indents = 9;
	var max_indent_range_in_pixels = indent_amount_in_pixels * max_indents; // 270/30 = 9 indents

	$("#parsonSolution_{{i}}, #parsonTrash_{{i}}").sortable({
		placeholder: 'example-placeholder',
		connectWith: ".example-list-{{i}}",
		revert: 150,
		start: function(event, ui){
			// Sets height of placeholder and adds shadow to dragged item
			current_container = event.target.id;
			ui.helper.addClass("cdk-drag-preview");
			placeholderHeight = ui.item.outerHeight();
			ui.placeholder.height(placeholderHeight);
			$('<div class="slide-placeholder-animator" data-height="' + placeholderHeight + '"></div>').insertAfter(ui.placeholder);
		},
		over: function(event, ui) {
			// Check if we moved outside box into another box 
			if (current_container == undefined){
				current_container = event.target.id;
				skip = false;
			} else if (current_container != event.target.id){
				skip = true;
				current_container = event.target.id;
			} else {
				skip = false;
			}
		},
		sort: function(event, ui){
			// Updates purple blue? indent line 
			
      // Skip this function and set purple indent to 0 if we hover from one box to another
			if (skip || $(this).attr('id').startsWith("parsonTrash_")) {
				$(ui.placeholder[0]).css("left", 0);
				return;
			}
			var offset = ui.position.left - ui.originalPosition.left;
			var direction = Math.sign(offset);

			var padding = $(ui.item[0]).css('margin-left'); // Keeps track of indent spacing
			var multiple = 0; // Keeps track of how much to add/substract depth
			if (Math.abs(offset) > indent_amount_in_pixels){
				multiple = Math.min(Math.round(Math.abs(offset) / indent_amount_in_pixels), max_indents);
				
				padding = parseInt(padding, 10) + (indent_amount_in_pixels * direction * multiple);
				
				if(padding < 0) padding = 0;
      }
      
      
      // Some reason putting this outside the if statement makes the purple blueish line show for every indent
      $(ui.placeholder[0]).css("left", padding);

			if (padding >= 0 && padding <= max_indent_range_in_pixels){
				$(ui.item[0]).attr('data-padding', padding);
				$(ui.item[0]).attr('data-multiple', multiple);
        $(ui.item[0]).attr("data-depth", (padding / indent_amount_in_pixels)); 

				if ($(ui.item[0]).attr("data-depth") < 0) $(ui.item[0]).attr("data-depth", 0);
			}
		},
		change: function(event, ui) {
			// Update placeholder height
			ui.placeholder.stop().height(0).animate({height: ui.item.outerHeight()}, 300);

			placeholderAnimatorHeight = parseInt($(".slide-placeholder-animator").attr("data-height"));

			$(".slide-placeholder-animator").stop().height(placeholderAnimatorHeight).animate({height: 0}, 300, 
			function() {
				$(this).remove();
				placeholderHeight = ui.item.outerHeight();
				$('<div class="slide-placeholder-animator" data-height="' + placeholderHeight + '"></div>').insertAfter(ui.placeholder);
			});
		},
		stop: function(event, ui) {
			// Remove animation class when done
			$(".slide-placeholder-animator").remove();
			skip = false;
		},
		receive: function(event, ui){
			// Reset indent of item when moving across boxes
			if (ui.sender){
				$(ui.item[0]).css("margin-left", 0);
				$(ui.item[0]).css("margin-right", 0);
				$(ui.item[0]).attr("data-depth", 0);
				$(ui.item[0]).attr("data-multiple", 0);
				$(ui.item[0]).attr("data-padding", 0);
			}
		},
		beforeStop: function(event, ui){
			// Remove shadow and update indent position of item and depth 
			ui.helper.removeClass("cdk-drag-preview");

			var padding = $(ui.item[0]).attr('data-padding');
			var multiple = $(ui.item[0]).attr('data-multiple');

			if (padding) padding = parseInt(padding);
			if (multiple) multiple = parseInt(multiple);

			if (padding >= 0 && padding <= max_indent_range_in_pixels){ 

				$(ui.item[0]).css("margin-left", padding); 
				$(ui.item[0]).css("margin-right", -padding); 
			}  
			console.log(ui.position); 
			console.log(ui.originalPosition); 
		},
	}); 

	// $.each($("#cdk-drop-list-3").children() ,function (index,item) { 
	// 	// Set id to elements and initialize
	// 	$(item).attr("data-id", index); 
	// 	$(item).attr("data-depth", 0); 
	// }); 
	
	// $("#button").click(()=> {
    // 	serialize($("#cdk-drop-list-3"));
	// });
	
	// This will serialize a box of items
	// example result: [{'id': 0, 
	//					'depth': 0, 
	//					'children': [
	//						{'id': 1, 'depth': 1}
	//					]}, 
	//					{'id': 2, 'depth': 0}]
    function serialize(box){
		var result = [];
		var previous_depth = $($(box).children()[0]).attr('data-depth');
		var stack = [];

		function step(obj, prev_obj, depth){
			if('children' in prev_obj){
				prev_obj['children'].push({'id': $(obj).attr('data-id'), 'depth': depth})
			} else {
				prev_obj['children'] = [];
				prev_obj['children'].push({'id': $(obj).attr('data-id'), 'depth': depth});
			}
			return prev_obj['children'][ prev_obj['children'].length -1];
		}

    	$.each($(box).children() ,function (index,item) {
      console.log($(item).attr('data-depth'), previous_depth);
			let depth = parseInt($(item).attr('data-depth'));

			if (depth < previous_depth){ 
				for(var i=previous_depth; i>= 0; i--){
					let top = stack[stack.length-1];
					if (top && top['depth'] >= depth){
						stack.pop();
					} else {
						break;
					}
				}
			} else if (depth == previous_depth) stack.pop();

			if (stack.length > 0){
				let top = stack[stack.length-1];

				let new_item = step(item, top, depth);
				previous_depth = depth;

				stack.push(new_item);
			} else {
				result.push({'id': $(item).attr('data-id'), 'depth': depth});
				stack.push(result[result.length-1]);
				previous_depth = depth;
      		}
      	});
		return result;
    }
  
  </script>
  <script>
    var countFeedbackButtonClicks_{{i}} = 0;
    //function that runs the pretty printing aka highliting of parsons
    if (window.prettyPrint() && (typeof (this.options.prettyPrint) === "undefined" || this.options.prettyPrint)) {
      prettyPrint();
    }
    $("#feedbackLink_{{i}}").click(function (event) {
      feedbackFunction_{{i}} ();
    });

    function feedbackFunction_{{i}} (){
      //getParsonFeedback();
      countFeedbackButtonClicks_{{i}} ++;
    }


    var seriousParson_{{i}} = {
      studentSolution: "",
        studentTrash: "",
        feebackClickCount: 0,
          loadParsonForSubmit: function () {
            seriousParson_{{i}}.studentSolution = serialize($("#parsonSolution_{{i}}"));
			seriousParson_{{i}}.studentTrash = serialize($("#parsonTrash_{{i}}"));
			console.log(seriousParson_{{i}});
            seriousParson_{{i}}.feebackClickCount = countFeedbackButtonClicks_{{i}};

            seriousParson_{{i}}.studentTrash = JSON.stringify(seriousParson_{{i}}.studentTrash);
            seriousParson_{{i}}.studentSolution = JSON.stringify(seriousParson_{{i}}.studentSolution);
          }
    };


    // function getParsonFeedback() {
    //   console.log("clicked");
    //   var r = new XMLHttpRequest();
    //   r.open("POST", "/oneUp/students/parsonDynamicGrader", true);
    //   r.onreadystatechange = function () {
    //     if (r.readyState != 4 || r.status != 200) return;
    //     alert("Success: " + r.responseText);
    //   };
    //   r.send("questionID={{q.questionID}}");
    // }
  </script>
{% endif %}
{% elif q.type == questionTypes.dynamic or q.type == questionTypes.templatedynamic %}
{% if graded %}
{% if q.numParts == 1 %}
<div class="row">
  <div class="col s12">
    <h5>Your Answer:</h5>
  </div>
</div>
<div class="row">
  {% for answer_blank_name, user_answer_value in q.user_answers.items %}
  <p>For answer blank <b>{{answer_blank_name}}</b>: {{user_answer_value}}</p>
  {% endfor %}
</div>
{% if showcorrect %}
<div class="row">
  <h5>Example Correct Answer: </h5>
  {% for ansName, text in q.sampleCorrect.items %}
  <b>{{ansName}}</b> : {{text|safe}}<br>
  {% empty %}
  No example correct answer provided by instructor.<br>
  {% endfor %}
</div>
{% endif %}
{% if q.evaluations %}
{% with evaluations=q.evaluations %}
{% include 'dynamicQuestionEvaluations.html' %}
{% endwith %}
{% endif %}
{% else %}
<div class="row">
  <h4>Question {{i}}</h4>
</div>
{% for pnum, qp in q.parts.items %}
{% if qp.submissionCount > 0 or pnum == "1" %}
<div class="row">
  <h5>Part {{pnum}} of {{q.numParts}}</h5>
</div>
<div class="card">
  <div id="qtext-{{i}}-{{pnum}}" class="card-content">
    {{qp.questionText|safe}}
  </div>
</div>
<script>disableInputsInside(document.getElementById("qtext-{{i}}-{{pnum}}"));</script>
<div class="row">
  <div class="col s12">
    <h5>Your Answer:</h5>
  </div>
</div>
<div class="row">
  {% for answer_blank_name, user_answer_value in qp.user_answers.items %}
  <p>For answer blank <b>{{answer_blank_name}}</b>: {{user_answer_value}}</p>
  {% endfor %}
</div>
{% if showcorrect %}
<div class="row">
  <h5>Example Correct Answer: </h5>
  {% for ansName, text in qp.sampleCorrect.items %}
  <b>{{ansName}}</b> : {{text|safe}}<br>
  {% empty %}
  No example correct answer provided by instructor.<br>
  {% endfor %}
</div>
{% endif %}
{% if qp.evaluations %}
{% with evaluations=qp.evaluations %}
{% include 'dynamicQuestionEvaluations.html' %}
{% endwith %}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
<div class="row">
  <div class="col s12">
    <p>Total for this question, You Scored: <b>{{q.user_points}}</b> Point(s) out of
      <b>{{q.total_points}}</b> Point(s)</p>
  </div>
  <div class="col s12">
    {% if q.feedback %}
    <p><b>Feedback: </b> {{q.feedback}}</p>
    {% endif %}
  </div>
</div>
{% endif %}
{# There's no else case because we don't need to show any answers when there's no grading. #}

{% endif %}