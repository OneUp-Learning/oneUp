<!DOCTYPE html>
<html lang="en">
   <head>
      {% include 'scripts.html' %}
      <script>
         jQuery.browser = {};
         (function () {
         jQuery.browser.msie = false;
         jQuery.browser.version = 0;
         if (navigator.userAgent.match(/MSIE ([0-9]+)\./)) {
         jQuery.browser.msie = true;
         jQuery.browser.version = RegExp.$1;
         }
         })();
      </script>
      <link href="/static/ThirdParty/js-parsons-master/parsons.css" rel="stylesheet" />
      <link href="/static/ThirdParty/js-parsons-master/lib/prettify.css" rel="stylesheet" />
      <script src="/static/ThirdParty/js-parsons-master/lib/prettify.js"></script>
      <!--                                 <script src="/static/ThirdParty/js-parsons-master/lib/jquery.min.js"></script> -->
      <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.min.js"></script>
      <script src="/static/ThirdParty/js-parsons-master/lib/jquery.ui.touch-punch.min.js"></script>
      <script src="/static/ThirdParty/js-parsons-master/lib/underscore-min.js"></script>
      <script src="/static/ThirdParty/js-parsons-master/lib/lis.js"></script>
      <script src="/static/ThirdParty/js-parsons-master/parsons.js"></script>
      <script src="/static/ThirdParty/ckeditor_4.6.2_custom1/ckeditor.js"></script>
      <script src="/static/ThirdParty/aceEditor/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
      <script type="text/javascript">
         // Set time out for the test if the time limit has reached 
         var duration = {{testDuration}}; //time limit in minutes from database
         var now = new Date();
         var milli = now.getMilliseconds(); //current time in milliseconds
         var limit = milli + (duration * 1000 * 60); // test time duration in milliseconds (current time + time limit in milliseconds)
         
         setTimeout("formSubmit()", limit); //if the time limit of the test has reached, the test will be submitted automatically
         
         function formSubmit() {
             document.getElementById('submit_hidden').click()
         };
         
         
      </script>
      <script>
         var ace_editor_divs = document.getElementsByClassName('ace-editor');
         var ace_editors = {};
         for (var i=0;i<ace_editor_divs.length;i++) {
             var new_editor = ace.edit(ace_editor_divs[i].id);
          new_editor.setTheme("ace/theme/chrome");
         new_editor.session.setMode("ace/mode/"+ace_editor_divs[i].title);
         ace_editors[ace_editor_divs[i].id] = new_editor;
         }
         
         var parson_divs = document.getElementsByClassName('parson');
         var parsons = {};
         
         function copyContentsToHidden() {
                for (var i=0;i<ace_editor_divs.length;i++) {
                    var name = ace_editor_divs[i].id;
                    var editor = ace_editors[name];
                    var hiddenfield = document.getElementById(name+"-hidden");
                    hiddenfield.value = editor.getValue();
                }
              
            
                
         }
         
         
      </script>
   </head>
   <body>
      {% include 'stheading.html' %}
      <main>
         <div class="row center-align">
            <div class="col s12">
               <h3>{{challengeName}}</h3>
               <p><b> Start Time:  {{startTime}}</b></p>
            </div>
         </div>
         <div class="row">
            <div class="col s12 l12 m8 offset-m2">
               <form id="TakeTest" name="TakeTest" action="/oneUp/students/ChallengeResults" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="startTime" id="startTime" value="{{startTime}}">
                  <input type="hidden" name="challengeId" value="{{challengeID}}"> 
                  <div class="card">
                     <div class="card-content">
                        {% for i,question in question_range %}
                        <div class="divider"></div>
                        <div class="row">
                           <p>{% autoescape off %} {{i}}. {{question.questionText|safe}} {% endautoescape %}</p>
                        </div>
                        {% if question.type == questionTypes.multipleChoice %}
                        <div class="row">
                           <div class="col s12">
                              {% for j,answer in question.answers_with_count %}
                              <div class="row">
                                 <input name="{{i}}-ans" type="radio" id="{{i}}ans-{{j}}" value="{{j}}" />
                                 <label for="{{i}}ans-{{j}}">{% autoescape off %}{{answer.answerText|safe}} {% endautoescape %}</label>
                              </div>
                              {% endfor %}
                           </div>
                        </div>
                        {% elif question.type == questionTypes.multipleAnswers %}
                        <div class="row">
                           <div class="col s12">
                              {% for j,answer in question.answers_with_count %}
                              <div class="row">
                                 <input name="{{i}}-ans" type="checkbox" id="{{i}}ans-{{j}}" value="{{j}}"/>
                                 <label for="{{i}}ans-{{j}}">{% autoescape off %}{{answer.answerText|safe}} {% endautoescape %}</label>
                              </div>
                              {% endfor %}
                           </div>
                        </div>
                        {% elif question.type == questionTypes.matching %}
                        <div class="row">
                           <div class="col s12 m6">
                              {% for j,answer in question.answers_with_count %}
                              <p>{{j}} . {{answer.answerText}}</p>
                              {% endfor %}
                           </div>
                        </div>
                        <div class="row">
                           {% for match in question.matches %}
                           <div class="input-field col s12 m4">
                              <select name="{{i}}-{{match.current_pos}}" id={{match.current_pos}}/>
                                 {% for k in match.answers_count %}
                                 <option value="{{k}}">{{k}}</option>
                                 {% endfor %}
                              </select>
                              <label for="{{match.current_pos}}">{{match.matchingAnswerText}}</label>
                           </div>
                           {% endfor %}
                        </div>
                        {% elif question.type == questionTypes.trueFalse  %}
                        <div class="row">
                           <div class="col s12">
                              <p>
                                 <input name="{{i}}-ans" type="radio" id="{{i}}ans1" value="t" class="validate" required/>
                                 <label for="{{i}}ans1">True</label>
                              </p>
                              <p> 
                                 <input name="{{i}}-ans" type="radio" id="{{i}}ans2" value="f" class="validate" required/>
                                 <label for="{{i}}ans2">False</label>
                              </p>
                           </div>
                        </div>
                        {% elif question.type == questionTypes.essay %}
                        <div class="row">
                           <div class="col s12">
                              <textarea style="border:solid 1px rgba(128, 128, 128, 0.5)" name="{{i}}-ans" rows="10" cols="90"></textarea>
                              <script type="text/javascript">
                                 CKEDITOR.config.autoParagraph = false;
                                 CKEDITOR.replace("{{question.questionID}}");
                              </script>
                           </div>
                        </div>
                        {% elif question.type == questionTypes.parsons %} 
                        <div class="row">
                           <div>
                              <div id="{{question.questionID}}_sortableTrash" class="sortable-code"></div>
                              <div id="{{question.questionID}}_sortable" class="sortable-code"></div>
                              <input type="hidden" name="{{i}}lineNo" id="{{question.questionID}}_lineNo" value="">
                              <input type="hidden" name="{{i}}errorDescription" id="{{question.questionID}}_errorDescription" value="">
                              <input type="hidden" name="{{i}}studentSol" id="{{question.questionID}}_studentSol" value="">
                              <input type="hidden" name="{{i}}lineIndent" id="{{question.questionID}}_lineIndent" value="">
                              <input type="hidden" name="{{i}}correctLineCount" id="{{question.questionID}}_correctLineCount" value="">
                              <input type="hidden" name="{{i}}feedBackButtonClickCount" id="{{question.questionID}}_feedBackButtonClickCount" value="">
                              <div style="clear:both;"></div>
                              <p>
                                 <a href="#{{question.questionID}}" id="newInstanceLink_{{question.questionID}}">New instance</a>
                                 <a href="#{{question.questionID}}" id="feedbackLink_{{question.questionID}}">Get feedback</a>
                              </p>
                              <script>
                                 //initial will hold the parson problem text, preformatted by django
                                    var initial_{{question.questionID}} = '{{question.model_solution}}' 
                                    
                                    //variable to get the errors statements that have been generated
                                    var logged_errors_{{question.questionID}} = [];
                                    var countFeedbackButtonClicks_{{question.questionID}} = 0;
                                    var submit_clicked_{{question.questionID}} = false;
                                    
                                    
                                    function displayErrors{{question.questionID}}(fb_{{question.questionID}}) {
                                        if(fb_{{question.questionID}}.errors.length > 0) {
                                        	
                                            alert(fb_{{question.questionID}}.errors[0]);
                                            console.log("Caller: {{question.questionID}}" );
                                 logged_errors_{{question.questionID}}.push(errors);
                                 
                                        }else{
                                        	if(submit_clicked_{{question.questionID}} == false){
                                        		countFeedbackButtonClicks_{{question.questionID}}--;
                                        	}
                                        }
                                    } 
                                 
                                 
                                    $(document).ready(function(){
                                    	   
                                        var parson_{{question.questionID}} = new ParsonsWidget({
                                            'sortableId': '{{question.questionID}}_sortable',
                                            'trashId': '{{question.questionID}}_sortableTrash',
                                            'max_wrong_lines': {{question.distractorCount}},
                                            'feedback_cb' : displayErrors{{question.questionID}}
                                        });
                                        parson_{{question.questionID}}.init(initial_{{question.questionID}});
                                        parson_{{question.questionID}}.shuffleLines();
                                        $("#newInstanceLink_{{question.questionID}}").click(function(event){
                                            event.preventDefault();
                                            parson_{{question.questionID}}.shuffleLines();
                                        });
                                        $("#feedbackLink_{{question.questionID}}").click(function(event){
                                            event.preventDefault();
                                            //this has to be cleared because otherwise they'll retain data
                                            errors = [], log_errors = [];
                                            studentCodeLineObjects = [];
                                            incorrectLines = [];
                                            
                                            console.log("Submit Clicked state:")
                                            console.log(submit_clicked_{{question.questionID}});
                                            
                                            if(submit_clicked_{{question.questionID}} == false){
                                            	countFeedbackButtonClicks_{{question.questionID}}++;
                                            	console.log("Feeback click state:")
                                            	console.log(countFeedbackButtonClicks_{{question.questionID}});
                                            	
                                            }
                                            console.log("Get Feedback: {{question.questionID}}");
                                            console.log(parson_{{question.questionID}}.getFeedback());
                                            console.log(logged_errors_{{question.questionID}});
                                            submit_clicked_{{question.questionID}} = false;
                                            
                                        });
                                        
                                        //on click display the contents of the student error log
                                        $("#submit").click(function(event){
                                        	
                                        	submit_clicked_{{question.questionID}} = true;
                                        	//we click the link here too, and it should not be counted against the student
                                        	document.getElementById("feedbackLink_{{question.questionID}}").click();
                                 
                                        	console.log("Parson problem: {{question.questionID}}:");
                                        	console.log("submit clicked");
                                       		
                                        	console.log("logged errors: ");
                                       		console.log(logged_errors_{{question.questionID}});
                                       		
                                       		console.log("incorrect lines!");
                                       		console.log(incorrectLines);
                                       		
                                       		console.log("student code lines objects!");
                                       		console.log(studentCodeLineObjects);
                                       		
                                       		//access the student code line objects
                                       		//peel away the object notation to get at the
                                       		//student's code text representation
                                       		var studentCode = [];
                                       		var lineIndentation = [];
                                       		
                                       		for (i = 0; i < studentCodeLineObjects.length; i++) {
                                       			studentCode.push(studentCodeLineObjects[i].code);
                                       			lineIndentation.push(studentCodeLineObjects[i].indent);
                                       		}
                                       		
                                       		console.log("Student code!");
                                       		console.log(studentCode);
                                       		
                                       		console.log("Line indent!");
                                       		console.log(lineIndentation);
                                       		
                                       		console.log("Feedback click count");
                                       		console.log(countFeedbackButtonClicks_{{question.questionID}});
                                       		
                                       		$("#{{question.questionID}}_lineNo").val(incorrectLines);
                                       		$("#{{question.questionID}}_errorDescription").val(logged_errors_{{question.questionID}});
                                       		$("#{{question.questionID}}_studentSol").val(studentCode);
                                       		$("#{{question.questionID}}_lineIndent").val(lineIndentation);
                                       		$("#{{question.questionID}}_correctLineCount").val(parson_{{question.questionID}}.model_solution.length);
                                       		$("#{{question.questionID}}_feedBackButtonClickCount").val(countFeedbackButtonClicks_{{question.questionID}});
                                       	});
                                       		
                                       		
                                    });
                                    
                              </script>
                           </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                     </div>
                     <div class="card-action right-align">
                        <input type="submit" id="submit_hidden" name="submit_hidden" style="display:none;">
                        <a id="submit" class="waves-effect waves-light btn modal-trigger" href="#modal_confirm"><i class="material-icons right">send</i>Submit Challenge</a></a>
                        <div id="modal_confirm" class="modal">
                           <div class="modal-content left-align">
                              <h5>Are you sure you want to submit?</h5>
                              <p>Once you submit the challenge, it cannot be reverted.</p>
                           </div>
                           <div class="modal-footer">
                              <a href="#!" class="modal-action modal-close waves-effect waves-light btn-flat">Cancel</a>
                              <button class="modal-action modal-close waves-effect waves-light btn-flat" type="submit" id="submit" name="submit" value="Submit" onclick="copyContentsToHidden()">Submit
                              </button>                                        
                           </div>
                        </div>
                     </div>
                  </div>
               </form>
            </div>
         </div>
      </main>
      <!-- Footer -->
      {% include 'footer.html' %}
   </body>
</html>