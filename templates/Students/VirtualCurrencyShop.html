<!DOCTYPE html>
<html lang="en">
   <head>
      {% include 'scripts.html' %}
   </head>
   <body>
      {% include 'stheading.html' %}  
      <main>
         <div class="row center-align">
            <div class="col s12">
               <h3>Your Course Shop</h3>
            </div>
         </div>
         <div class="row">
            <div class="col s12 m10 offset-m1">
               <div class="card">
                  <div class="card-content">
                     <!-- <form id="store" name="store" action="#" onsubmit="return updatePrices()" method="post"> -->
                     <form id="store" name="store" action="#" onsubmit="return checkTotal()" method="post">
                        {% csrf_token %}					
                        <table class="responsive-table">
                           <thead>
                              <tr>
                                 <th>Name</th>
                                 <th>Description</th>
                                 <th>Price</th>
                                 <th>Quantity</th>
                                 <th>For Assignment</th>
                                 <th class="center-align">Remaining</th>
                                 <th>Cost</th>
                              </tr>
                           </thead>
                           <tbody>
                              {% for buyOpt in buyOptions %}
                              <tr>
                                 <td>{{buyOpt.displayName}}</td>
                                 <td>{{buyOpt.description}}</td>
                                 <td>{{buyOpt.cost}}</td>
                                 <td><input name="buyOptionQuantity{{buyOpt.id}}" id="buyOptionQuantity{{buyOpt.id}}" type="number" min="0" {% if buyOpt.remaining != 0 %} max="{{buyOpt.remaining}}" {% else %} max="99" {% endif %} value="0"></td>
                                 <td>
                                    {% if buyOpt.challenges != None and buyOpt.challenges != 0 %}
                                    <select name="challengeFor{{buyOpt.id}}">
                                       <option value="none">None</option>
                                    {% for id, name in buyOpt.challenges %}
                                        <option value="{{id}}">{{name}}</option>
                                    {% endfor %}
                                    </select>
                                    {% endif %}
                                </td>
                                 <td class="center-align">{% if buyOpt.remaining != 0 %} {{buyOpt.remaining}} {% endif %}</td>
                                 <td id="priceFor{{buyOpt.id}}">0</td>
                              </tr>
                              {% empty %}
                              <tr>
                                 <td class="center-align" colspan="6"><i>No Items in Shop</i></td>
                              </tr>
                              {% endfor %}
                        </table>
                        <table>
                           <thead>
                              <tr>
                              <th>Your current balance: {{studentVirtualCurrency}}</th>
                              <th class="secondary-content"><span id="total" class="black-text">Total: 0</span></th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr>
                                 <td></td>
                                 <td class="secondary-content"><button class="btn waves-effect waves-light" type="submit" name="buy" value="Buy">Buy
                                    <i class="material-icons left">attach_money</i>
                                    </button>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </form>
                  </div>
                  <div class="card-action right-align">
                    <div class="row right-align">
                        <div class="col s12">
                            <a class="waves-effect waves-light btn" href="/oneUp/students/StudentCourseHome"><i class="material-icons left">navigate_before</i>Back</a>
                        </div>
                    </div>
                  </div>
               </div>
            </div>
         </div>
      </main>
      {% include 'footer.html' %}
      <script>
         var prices=[{% for buyOpt in buyOptions %}{{buyOpt.cost}},{%endfor%}];
         var indexes = [{% for buyOpt in buyOptions %} {{buyOpt.id}}, {% endfor %}];
         function updatePrices() {
         	var len = prices.length;
         	var total = 0;
         	for (var i = 0; i < len; i++) {
         		if (document.getElementById("buyOptionQuantity"+indexes[i]).value.length > 3){
         			document.getElementById("buyOptionQuantity"+indexes[i]).value = document.getElementById("buyOptionQuantity"+indexes[i]).value.slice(0, 3);
         		}
         		var quantity = document.getElementById("buyOptionQuantity"+indexes[i]).value;
         		var price = quantity*prices[i];
         		total += price;
         		document.getElementById("priceFor"+indexes[i]).innerHTML = price;
         		
         	}
         	document.getElementById("total").innerHTML =  "Total: " +  total;
         	//GGM checkTotal();
         }
         function checkQuantity(){
            for(var i = 0; i < indexes.length; i++){
               if(document.getElementById("buyOptionQuantity"+indexes[i]).value > 0)
                  return true;
            }
            return false;
         }
         function checkTotal(){
         	var total = document.getElementById("total").innerHTML;
         	total = total.slice(7);	//GGM get number out of string
         	if ( {{studentVirtualCurrency}} - parseInt(total) < 0 ) {	
              alert("You do not have enough money ");
              return false;
           	}
         	if(parseInt(total) == 0 && !checkQuantity()){	//GGM added case to check if zero total
         		alert("You have not bought anything.")
         		return false;
         	}
         	return true;	//GGM
         }
         
         for (var i=0; i < {{numBuyOptions}}; i++) {
         	document.getElementById("buyOptionQuantity"+indexes[i]).addEventListener('change',updatePrices);
         }
      </script>
   </body>
</html>