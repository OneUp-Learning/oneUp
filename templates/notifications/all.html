<!DOCTYPE html>
<html lang="en">
<head>

	{% include 'scripts.html' %}
	<!-- Used for the notifications -->
		{% load staticfiles %}       
		{% load notification_tags %}
		
		{% if ID != 2 %}
		<script>
		function timeDifference(earlierdate) {
			
            var difference = (Math.floor(Date.now()/1000) - earlierdate) /1000;
         
            var daysDifference = difference;            
            daysDifference /= (60 * 60 * 24);
            daysDifference = Math.abs(Math.round(daysDifference));
         
            var hoursDifference = difference;          
            hoursDifference /= (60 * 60);
            hoursDifference =  Math.abs(Math.round(hoursDifference));
         
            var minutesDifference = difference;            
            minutesDifference /= 60;
            minutesDifference = Math.abs(Math.round(minutesDifference));
         
         
         	console.log('difference = ' + daysDifference + ' day/s ' + hoursDifference + ' hour/s ' + minutesDifference + ' minute/s');
         	return [daysDifference, hoursDifference, minutesDifference ];
         
         
        }
		
		
		 // Ajax-Notification related callback urls.
        var updateNotificationUrl = "NotificationPageUpdate";        

        // Update a notification using AJAX.
        $(document).ready(function updateNotifications() {
        	var box = document.getElementById("nTable");
        	var table = document.getElementById("T1");
    		var flag = table.rows[1].getAttribute('data-nf-id');
    		console.log(flag);
    		//var flag2 = first.getAttribute('data-nf-id');
    		
            var $notification_box = $('#T1');

            if (!flag || $notification_box.length == 0) {
            	console.log('Something went wrong');
                return;0
            }

            $.ajax({
                type: 'GET',
                url: 'NotificationPageUpdate/' + '?flag=' + flag,
                //success: updateSuccess(response),
                success: function (response) {
                    //console.log(response);
                    for (var i in response.notifications){
                    	// Create an empty <tr> element and add it to the 1st position of the table:
                    	var row = table.insertRow(1);
                    	var cell1 = row.insertCell(0);
                    	var cell2 = row.insertCell(1);
                    	var cell3 = row.insertCell(2);
                    	
                    	newN = response.notifications[i];
                    	timeStamp = response.timeStamps[i];
                    	console.log(newN);
                    	
                    	row.id = newN.id;
                    	row.className += 'notification ';
                    	row.className += 'list-group-item ';
                    	row.setAttribute("data-nf-id", newN.id);
                    	
                    	cell1.innerHTML =  newN.verb;

                    	
                    	  
                    	var TimeArray = timeDifference(timeStamp);
                    	var days = TimeArray[0];
                    	var hours = TimeArray[1];
                    	var mins = TimeArray[2];
                    	
                    	var timeString = "";

                    	if(hours == 0 && days ==0 && mins == 0){
                			timeString = "0 minutes";
                		}
                    	
                    	if(days != 0){
							console.log("In the Days")
                    		if(days == 1){ //1 day
                    			timeString = timeString + days + "day";
                    		} else { // X days
                    			timeString = timeString + days + "days";	
                    		}	
                    	} 
                    	
                    	if(hours != 0){
							console.log("In the hours")
                    		if(hours == 1){
                    			timeString = timeString + hour + "hour";
                    		} else {
                    			timeString = timeString + hour + "hours";
                    		}
                    	} 
                    	
                    	if(mins != 0) { //The day and hours are z
							console.log("In the mins")
                    		 if (mins == 1){
                    			timeString = timeString + mins + "minute";

                    		} else {
                    			timeString = timeString + mins + "minutes";
                    		}		
                    	}
                    	
                    	cell2.innerHTML = '<span class="timesince">'+timeString+' ago</span>'; 	


                    	
                    	
                    	if(!newN.read){
                    		row.className += 'unread';
                            var aString = '<button data-id="'+ newN.id+'" class="mark-notification" data-mark-action="read" data-toggle-text="Mark as read"> Mark as read </button> <button class="delete-notification" data-id="'+ newN.id +'">X</button>';
                           	//console.log('\n \n'+aString);
                           	var aString2 = '<button>This is a test</button>';
                           	cell3.style="padding-left: 50px;";
                           	cell3.innerHTML = aString;
                    	}
                    	
                    }
                },
                complete: function () {
                    setTimeout(updateNotifications, 5000);
                    
                }
            });
        });
		</script>
		{% endif %}
</head>
 
<body>



	<div id="page-wrapper">
	{% if is_teacher %}    
              {% include 'heading.html' %}
       {% else %}
              {% include 'stheading.html' %}
       {% endif %}

       
 
		<div class="frame" id="grad" align="center">
        <div class="container">
        <div class="row">
        <div class="12u">
        	<h1>Notifications</h1>
        	<a href="/oneUp/students/NotificationPage?ID=1">All Notifications</a> <br/>
        	<a href="/oneUp/students/NotificationPage?ID=0">Active Notifications</a><br/>
        	<a href="/oneUp/students/NotificationPage?ID=2">Deleted Notifications</a>
		</div>
		</div>
		<br />
		
		<div align="center">
			
   			<div id="nTable" class="notification-box-list ">
   			<table id='T1' class="bg" style="margin-bottom: .750em; width: 80%; align: center;">
   			<tr>
   				<th>Notification Description</th>
   				<th>Notification Timestamp</th>
   				<th style="padding-left: 100px;">Options</th>
   			</tr>
   			
   			
   			
   			{% if ID == 0 %}
   				{% user_notifications%}
   				
   			{% elif ID == 1 %}
   				{% render_notifications using request.user.notifications.all %}
   				
   			{% elif ID == 2 %}
   				{% render_notifications using request.user.notifications.deleted %}
   				
            {% endif %}	
   			</table>
   			</div>
   			                              
  
		<br/><br><br>
        <!-- END DYNAMIC TABLE -->
		</div>
        </div>
	<!-- Footer -->


	</div>`
	     {% include 'footer.html' %}
	
	
</body>
</html>