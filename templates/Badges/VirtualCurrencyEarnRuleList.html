<!DOCTYPE html>
<html lang="en">

<head>
	{% include 'scripts.html' %}
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>

<body>
	{% include 'heading.html' %}
	<main>
		<div class="row center-align">
			<div class="col s12">
				<h3>{% if isRuleCustom == True %}Manual {% else %} Automatic {% endif %} Virtual Currency Earn
					Rules</h3>
			</div>
		</div>

			{% if isRuleCustom == True %}
			<input type="hidden" name="isRuleCustom" value="true">
			{% else %}
			<input type="hidden" name="isRuleCustom" value="false">
			{% endif %}

			{% csrf_token %}
			<div class="row right-align">
				<div class="col s12 m10 offset-m1">
					<a class="waves-effect waves-light btn" href="/oneUp/badges/CreateVirtualCurrencyRule?isRuleCustom={{isRuleCustom}}"><i
						 class="material-icons left">add_circle</i> {% if isRuleCustom == True %}Add
						A Manual Earning Rule{% else %}Add AN Automatic Earning Rule{% endif %}</a>
				</div>
			</div>
			<div class="row">
                <div class="col s12 m10 offset-m1">
                        <div class="card-content">
                          <ul id="sortableRules" class="collapsible" >
						
									{% for i,vcRuleID,vcRuleName,vcRuleDescription, vcAmount, position in vcRuleInfo %}
									 <li id={{vcRuleID}}>
									 <div class="collapsible-header" > <i class="material-icons">swap_vert</i> 
										<span style="max-width: 27%;min-width: 27%;">{{vcRuleName}}</span>
										<span style="max-width: 27%;min-width: 27%;"">{{vcRuleDescription}}</span>
										{%if isRuleCustom == True and vcAmount == 0 %}
										<td>Varies</td>
										{% else %}
										<td>{{vcAmount}}</td>
										{% endif %}
									
										<span class="right-align badge">
											<a class="dropdown-button tooltipped secondary-content" href="#!" data-constrainwidth="false"
											 data-beloworigin="true" data-activates='dropdown-{{i}}' data-position="right" data-delay="50" data-tooltip="Options"><i
												 class="material-icons">more_vert</i></a>
											<ul id='dropdown-{{i}}' class='dropdown-content'>
												<li><a href="/oneUp/badges/EditVirtualCurrencyRule?vcRuleID={{vcRuleID}}&isRuleCustom={{isRuleCustom}}">Edit</a></li>
												<li class="divider"></li>
												<li><a class="modal-trigger" href="#modal_delete-{{i}}">Delete</a></li>
											</ul>
											<div id="modal_delete-{{i}}" class="modal">
												<div class="modal-content">
													<h5>Are you sure you want to delete?</h5>
												</div>
												<div class="modal-footer">
													<a href="#!" class="modal-action modal-close waves-effect waves-light btn-flat secondary-colored-text">Cancel</a>
													<button class="modal-action modal-close waves-effect waves-light btn-flat" type="button" name="submit"
													 value="Delete" onclick="deleteRule('{{vcRuleID}}', '{{isRuleCustom}}')">Delete
													</button>
												</div>
											</div>
										</span>
									</li>
									{% empty %}
									<li>
										<div class="center-align" colspan="3"><i>No rules created</i></div>
									</li>
									{% endfor %}
								<ul>
								<script>
										$( function() {
											$( "#sortableRules" ).sortable({

												stop: function(event, ui) {

												var itemOrder = $("#sortableRules").sortable("toArray");

												var idsPositions = []

												for (var i = 0; i < itemOrder.length; i++) {
													if (itemOrder[i]){
														idsPositions.push(String(itemOrder[i])+"---"+String(i));
													}
												}

												var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

												console.log(idsPositions)

												$.post( "/oneUp/instructors/ReorderVCRules", {ruleIdsPositions: idsPositions , csrfmiddlewaretoken: csrftoken,}, function( data ) {
													console.log(data)
												});

												}
												});
											});
										</script>
						</div>
					</div>
				</div>
	</main>
	{% include 'footer.html' %}
</body>
<script>
	function deleteRule(rule_id, rule_custom) {
		function getCookie(name) {
			var cookieValue = null;
			if (document.cookie && document.cookie !== '') {
				var cookies = document.cookie.split(';');
				for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					// Does this cookie string begin with the name we want?
					if (cookie.substring(0, name.length + 1) === (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}

		function csrfSafeMethod(method) {
			// these HTTP methods do not require CSRF protection
			return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}

		var csrftoken = getCookie('csrftoken');
		$.ajaxSetup({
			beforeSend: function (xhr, settings) {
				if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
					xhr.setRequestHeader("X-CSRFToken", csrftoken);
				}
			}
		});
		$.ajax({
			type: "POST",
			url: "/oneUp/badges/SaveVirtualCurrencyRule",
			data: {
				'vcRuleID': rule_id, // from form
				'isRuleCustom': rule_custom,
				'edit': 'edit',
				'delete': 'delete'
			},
			success: function () {
				console.log("Deleted");
				location.reload();
			}
		});
	}
</script>

</html>