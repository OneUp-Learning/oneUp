<!DOCTYPE html>
<html lang="en">

<head>
   {% include 'scripts.html' %}
</head>

<body>
   {% include 'heading.html' %}
   <main>
      <div class="row center-align">
         <div class="col s12">
            <h3>Students</h3>
         </div>
      </div>
      <div class="row right-align">
         <div class="col s12 m10 offset-m1">
            <form id="uploadbanner" name="uploader">
               {% csrf_token %}
               <input type="hidden" name="file_number" id="file_number" value="">
               <div class="row">
                  <div class="row">
                     <div class="col s12 m5">
                        <div class="file-field input-field">
                           <div class="btn">
                              <span>Import Students</span>
                              <input id="fileupload" name="studentslist" type="file">
                           </div>
                           <div class="file-path-wrapper ">

                              <input class="file-path validate" type="text" placeholder="Import Students">
                           </div>
                        </div>
                     </div>
                     <div class='input-field col s6 m4'>
                        <input id='email_domain_name' name='email_domain_name' type='text' class='validate' required>
                        <label for='email_domain_name'>School Email Domain (The part after the @)</label>
                     </div>
                     <div class="input-field col s3">
                        <select id="file_type" name="file_number">
                           {% for i, csv_type in file_types %}
                           <option value="{{i}}">File Type: {{csv_type.display_name}}</option>
                           {% endfor %}
                        </select>
                     </div>
                  </div>
                  <button class="btn waves-effect waves-light" type="button" id="Upload" name="upload" value="Import"
                     onclick="importStudents()">Import
                     <i class="material-icons right">file_upload</i>
                  </button>
               </div>
            </form>
            <a class="waves-effect waves-light btn" href="/oneUp/instructors/addStudentListView"><i
                  class="material-icons left">add_circle</i>Add Existing Student</a>
            <a class="waves-effect waves-light btn" href="/oneUp/instructors/createStudentView"><i
                  class="material-icons left">add_circle</i>Add New Student</a>
         </div>
      </div>
      <div class="row">
         <div class="col s12 m10 offset-m1">
            <div class="card-panel">
               <table class="responsive-table">
                  <thead>
                     <tr>
                        <th>Avatar</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Last Action</th>
                     </tr>
                  </thead>
                  <tbody>
                     {% for i,userID,first_Name,last_Name,user_Email,user_Action, user_Avatar in user_range %}
                     <tr>
                        <td><img alt="Avatar Image" class="circle" width="35" height="35" src="{{user_Avatar}}"></td>
                        <td>{{first_Name}}</td>
                        <td>{{last_Name}}</td>
                        <td>{{user_Email}}</td>
                        <td>{{user_Action}}</td>
                        <td>
                           <form action="/oneUp/instructors/deleteStudent" method="POST">
                              {% csrf_token %}
                              <input type="hidden" name="userID" value="{{userID}}">
                              <a class="dropdown-button tooltipped secondary-content" href="#!"
                                 data-constrainwidth="false" data-beloworigin="true" data-activates='dropdown-{{i}}'
                                 data-position="right" data-delay="50" data-tooltip="Options"><i
                                    class="material-icons">more_vert</i></a>
                              <ul id='dropdown-{{i}}' class='dropdown-content'>
                                 <li><a href="/oneUp/instructors/createStudentView?userID={{userID}}">Edit</a></li>
                                 <li class="divider"></li>
                                 <li><a class="modal-trigger" href="#modal_delete-{{i}}">Delete</a></li>
                              </ul>
                              <div id="modal_delete-{{i}}" class="modal">
                                 <div class="modal-content">
                                    <h5>Are you sure you want to delete?</h5>
                                 </div>
                                 <div class="modal-footer">
                                    <a href="#!" class="modal-action modal-close waves-effect waves-light btn-flat"
                                       style="color: #00bcd4">Cancel</a>
                                    <button class="modal-action modal-close waves-effect waves-light btn-flat"
                                       type="submit" name="submit" value="Delete">Delete
                                    </button>
                                 </div>
                              </div>
                           </form>
                        </td>
                     </tr>
                     {% empty %}
                     <tr>
                        <td class="center-align" colspan="5"><i>No Students</i></td>
                     </tr>
                     {% endfor %}
                  </tbody>
               </table>
            </div>
         </div>
      </div>
      <div id="users-modal" class="modal">
         <div class="modal-content">
            <h4>Generated Student Passwords</h4>
            <p>We generated passwords for students that are new to Oneup. Please copy these passwords to a safe place.
               <b>After closing this window these passwords will not be shown again.</b></p>
            <ul class="collection">
               <li class='collection-item'>
                  <table class="responsive-table highlight">
                     <thead>
                        <tr>
                           <th>Student</th>
                           <th>Password</th>
                           <th></th>
                        </tr>
                     </thead>

                     <tbody id="users">
                        <tr>
                           <td>Sam Man (sman432@fsu.edu)</td>
                           <td>sCUgv-N_V3i0waPR4K2fFQ</td>
                           <td><span class="new badge cyan" data-badge-caption="">New</span></td>
                        </tr>
                        <tr>
                           <td>Sam Man (sman432@fsu.edu)</td>
                           <td>This student is already using Oneup</td>
                           <td></td>
                        </tr>
                     </tbody>
                  </table>
               </li>
            </ul>
         </div>
         <div class="modal-footer">
            <a href="#!" class="modal-action modal-close waves-effect waves-light btn-flat"
               style="color: #00bcd4">Close</a>
         </div>
      </div>
   </main>
   {% include 'footer.html' %}
</body>
<script>
   function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
         var cookies = document.cookie.split(';');
         for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
               cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
               break;
            }
         }
      }
      return cookieValue;
   }

   function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
   }

   var csrftoken = getCookie('csrftoken');
   $.ajaxSetup({
      beforeSend: function (xhr, settings) {
         if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
         }
      }
   });

   function validateFileSelection() {
      x = document.forms["uploader"]["studentslist"].value;
      if (x == "") {
         alert("Please choose a file.");
         return false;
      }

   }

   function importStudents() {
      //   console.log("validating");
      if (validateFileSelection() == false) return false;

      $.ajax({
         type: "POST",
         url: "/oneUp/instructors/importStudentsView",
         data: new FormData($('#uploadbanner')[0]),
         cache: false,
         contentType: false,
         processData: false,
         success: function (response) {
            console.table(response);
            let users = response['users'];

            // If there are no users just go ahead and refresh the page
            if (users.length == 0) {
               window.location.reload();
               return;
            }

            let users_container = $("#users");
            users_container.empty();

            // Add the users information to users container
            for (var index = 0; index < users.length; index++) {
               let user_info = users[index];
               if (user_info['new'] == true) {
                  users_container.append("<tr>\n" +
                     "<td>" + user_info['first-name'] + " " + user_info['last-name'] + "</td>\n" +
                     "<td>" + user_info['password'] + "</td>\n" +
                     "<td><span class='new badge cyan' data-badge-caption=''>New</span></td>\n" +
                     "</tr>");
               } else {
                  users_container.append("<tr>\n" +
                     "<td>" + user_info['first-name'] + " " + user_info['last-name'] + "</td>\n" +
                     "<td>Already in Oneup System</td>\n" +
                     "<td></td>\n" +
                     "</tr>");
               }
            }
            // Show the users
            $('#users-modal').modal('open');
         }
      });
      return false;
   }
   $(function () {
      $('#users-modal').modal({
         dismissible: false, // Modal can be dismissed by clicking outside of the modal
         opacity: .5, // Opacity of modal background
         inDuration: 300, // Transition in duration
         outDuration: 200, // Transition out duration
         startingTop: '4%', // Starting top style attribute
         endingTop: '10%', // Ending top style attribute

         complete: function () {
            window.location.reload();
         } // Callback for Modal close
      });
   });
</script>

</html>